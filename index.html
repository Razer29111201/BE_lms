<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .dashboard-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .dashboard-card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-card-header h3 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dashboard-card-header h3 i {
      color: var(--primary);
    }

    .dashboard-card-body {
      padding: 16px 20px;
    }

    .dashboard-card-body .empty {
      color: var(--text-muted);
      text-align: center;
      padding: 20px;
    }

    .mini-table {
      width: 100%;
    }

    .mini-table td {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .mini-table tr:last-child td {
      border-bottom: none;
    }

    .mini-table .label {
      color: var(--text-muted);
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .quick-stat {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .quick-stat .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .quick-stat .label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .session-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .session-item:last-child {
      border-bottom: none;
    }

    .session-time {
      background: var(--primary);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      margin-right: 12px;
      min-width: 60px;
      text-align: center;
    }

    .session-info {
      flex: 1;
    }

    .session-info .class-name {
      font-weight: 600;
    }

    .session-info .meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .trial-progress {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .trial-progress .bar {
      flex: 1;
      height: 6px;
      background: var(--bg-secondary);
      border-radius: 3px;
      overflow: hidden;
    }

    .trial-progress .bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
    }

    .trial-progress .text {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i
              class="fas fa-bars"></i></button>
          <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Xin chào, <span id="welcomeName">User</span>!</p>
          </div>
        </div>
        <div class="header-right">
          <button class="theme-toggle" onclick="theme.toggle()" title="Đổi giao diện">
            <i class="fas fa-moon"></i>
            <i class="fas fa-sun"></i>
          </button>
          <div class="user-menu" onclick="auth.logout()">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
              <div class="user-name" id="userName">User</div>
              <div class="user-role" id="userRole">Role</div>
            </div>
          </div>
        </div>
      </header>

      <div class="page-content">
        <div id="dashboardContent">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="js/app.js"></script>
  <script src="js/sidebar.js"></script>
  <script>
    async function loadDashboard() {
      const role = auth.user?.role_name;
      const container = document.getElementById('dashboardContent');

      try {
        let endpoint = '/dashboard/admin';
        if (role === 'SALE') endpoint = '/dashboard/sale';
        else if (role === 'TEACHER') endpoint = '/dashboard/teacher';
        else if (role === 'CM') endpoint = '/dashboard/cm';

        const query = branch.buildQuery({});
        const result = await api.get(endpoint + query);
        const data = result.data;

        if (role === 'ADMIN') renderAdminDashboard(container, data);
        else if (role === 'SALE') renderSaleDashboard(container, data);
        else if (role === 'TEACHER') renderTeacherDashboard(container, data);
        else if (role === 'CM') renderCMDashboard(container, data);
        else container.innerHTML = '<div class="empty-state"><p>Không có quyền truy cập</p></div>';
      } catch (error) {
        container.innerHTML = `<div class="empty-state"><p>Không thể tải dữ liệu: ${error.message}</p></div>`;
      }
    }

    function renderAdminDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${data.students?.active || 0}</div><div class="stat-label">Học sinh (${data.students?.total || 0} tổng)</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${data.classes?.active || 0}</div><div class="stat-label">Lớp đang hoạt động</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-chalkboard-teacher"></i></div><div class="stat-content"><div class="stat-value">${data.teachers || 0}</div><div class="stat-label">Giáo viên</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-user-tie"></i></div><div class="stat-content"><div class="stat-value">${data.cms || 0}</div><div class="stat-label">CM</div></div></div>
          <div class="stat-card"><div class="stat-icon secondary"><i class="fas fa-headset"></i></div><div class="stat-content"><div class="stat-value">${data.sales || 0}</div><div class="stat-label">Sale</div></div></div>
          <div class="stat-card"><div class="stat-icon danger"><i class="fas fa-user-clock"></i></div><div class="stat-content"><div class="stat-value">${data.trials?.active || 0}</div><div class="stat-label">Học thử (${data.trials?.converted || 0} đã convert)</div></div></div>
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-calendar-check"></i></div><div class="stat-content"><div class="stat-value">${data.experiences?.today || 0}</div><div class="stat-label">Trải nghiệm hôm nay</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-tasks"></i></div><div class="stat-content"><div class="stat-value">${data.assignments || 0}</div><div class="stat-label">Bài tập</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-day"></i> Buổi học hôm nay</h3><span class="badge badge-info">${data.todaySessions?.length || 0}</span></div>
            <div class="dashboard-card-body">
              ${data.todaySessions?.length ? data.todaySessions.map(s => `
                <div class="session-item">
                  <div class="session-time">${s.start_time?.substring(0, 5)}</div>
                  <div class="session-info">
                    <div class="class-name">${s.class_name} - Buổi ${s.session_number}</div>
                    <div class="meta">GV: ${s.teacher_name || 'N/A'}</div>
                  </div>
                  <span class="badge ${s.attendance_submitted ? 'badge-success' : 'badge-warning'}">${s.attendance_submitted ? 'Đã ĐD' : 'Chưa ĐD'}</span>
                </div>
              `).join('') : '<p class="empty">Không có buổi học hôm nay</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-user-clock"></i> Học sinh thử đang hoạt động</h3></div>
            <div class="dashboard-card-body">
              ${data.recentTrials?.length ? `<table class="mini-table">
                ${data.recentTrials.map(t => `<tr>
                  <td><strong>${t.full_name}</strong><br><small class="text-muted">${t.subject_name || ''}</small></td>
                  <td>${t.parent_phone}</td>
                  <td>
                    <div class="trial-progress">
                      <div class="bar"><div class="bar-fill" style="width:${(t.sessions_attended / t.max_sessions) * 100}%"></div></div>
                      <span class="text">${t.sessions_attended}/${t.max_sessions}</span>
                    </div>
                  </td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Không có học sinh thử</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-plus"></i> Lịch trải nghiệm gần đây</h3><a href="pages/experience.html" class="btn btn-sm btn-secondary">Xem tất cả</a></div>
            <div class="dashboard-card-body">
              ${data.recentExperiences?.length ? `<table class="mini-table">
                ${data.recentExperiences.map(e => `<tr>
                  <td><strong>${e.student_name}</strong><br><small class="text-muted">${e.subject_name || ''}</small></td>
                  <td>${ui.formatDate(e.scheduled_date)}<br><small>${e.scheduled_time?.substring(0, 5)}</small></td>
                  <td><span class="badge badge-${e.status === 'pending' ? 'warning' : e.status === 'completed' ? 'success' : e.status === 'converted' ? 'info' : 'secondary'}">${e.status}</span></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Chưa có lịch trải nghiệm</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-user-plus"></i> Học sinh mới</h3><a href="pages/students.html" class="btn btn-sm btn-secondary">Xem tất cả</a></div>
            <div class="dashboard-card-body">
              ${data.recentStudents?.length ? `<table class="mini-table">
                ${data.recentStudents.map(s => `<tr>
                  <td><strong>${s.full_name}</strong></td>
                  <td><code>${s.student_code}</code></td>
                  <td class="text-muted">${ui.formatDate(s.created_at)}</td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Chưa có học sinh</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderSaleDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${data.students?.active || 0}</div><div class="stat-label">Học sinh của tôi</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${data.experiences?.today || 0}</div><div class="stat-label">Trải nghiệm hôm nay</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-user-clock"></i></div><div class="stat-content"><div class="stat-value">${data.trials?.active || 0}</div><div class="stat-label">Đang học thử</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-user-check"></i></div><div class="stat-content"><div class="stat-value">${data.trials?.converted || 0}</div><div class="stat-label">Đã chuyển đổi</div></div></div>
          <div class="stat-card"><div class="stat-icon danger"><i class="fas fa-clock"></i></div><div class="stat-content"><div class="stat-value">${data.experiences?.pending || 0}</div><div class="stat-label">Chờ trải nghiệm</div></div></div>
          <div class="stat-card"><div class="stat-icon secondary"><i class="fas fa-check-circle"></i></div><div class="stat-content"><div class="stat-value">${data.experiences?.completed || 0}</div><div class="stat-label">Đã hoàn thành</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-check"></i> Lịch trải nghiệm hôm nay</h3><a href="pages/experience.html" class="btn btn-sm btn-primary">+ Thêm lịch</a></div>
            <div class="dashboard-card-body">
              ${data.todayExperiences?.length ? data.todayExperiences.map(e => `
                <div class="session-item">
                  <div class="session-time">${e.scheduled_time?.substring(0, 5)}</div>
                  <div class="session-info">
                    <div class="class-name">${e.student_name}</div>
                    <div class="meta">${e.customer_name} - ${e.customer_phone}</div>
                  </div>
                  <span class="badge badge-${e.status === 'pending' ? 'warning' : 'success'}">${e.status === 'pending' ? 'Chờ' : 'Xong'}</span>
                </div>
              `).join('') : '<p class="empty">Không có lịch trải nghiệm hôm nay</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-user-clock"></i> Học sinh đang học thử</h3><a href="pages/trial.html" class="btn btn-sm btn-secondary">Xem tất cả</a></div>
            <div class="dashboard-card-body">
              ${data.activeTrials?.length ? `<table class="mini-table">
                ${data.activeTrials.map(t => `<tr>
                  <td><strong>${t.full_name}</strong><br><small class="text-muted">${t.subject_name || ''}</small></td>
                  <td>${t.parent_phone}</td>
                  <td>
                    <div class="trial-progress">
                      <div class="bar"><div class="bar-fill" style="width:${(t.sessions_attended / t.max_sessions) * 100}%"></div></div>
                      <span class="text">${t.sessions_attended}/${t.max_sessions}</span>
                    </div>
                  </td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Không có học sinh học thử</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderTeacherDashboard(container, data) {
      const stats = data.stats || {};
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${stats.total_classes || 0}</div><div class="stat-label">Lớp đang dạy</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${stats.total_students || 0}</div><div class="stat-label">Học sinh</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${stats.today_sessions || 0}</div><div class="stat-label">Buổi học hôm nay</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-tasks"></i></div><div class="stat-content"><div class="stat-value">${stats.total_assignments || 0}</div><div class="stat-label">Bài tập đã giao</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-day"></i> Buổi học hôm nay</h3></div>
            <div class="dashboard-card-body">
              ${data.todaySessions?.length ? data.todaySessions.map(s => `
                <div class="session-item">
                  <div class="session-time">${s.start_time?.substring(0, 5)}</div>
                  <div class="session-info">
                    <div class="class-name">${s.class_name} - Buổi ${s.session_number}</div>
                    <div class="meta">${s.student_count} học sinh</div>
                  </div>
                  ${s.attendance_submitted
          ? '<span class="badge badge-success">Đã điểm danh</span>'
          : `<a href="pages/attendance.html?sessionId=${s.id}" class="btn btn-sm btn-primary">Điểm danh</a>`}
                </div>
              `).join('') : '<p class="empty">Không có buổi học hôm nay</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-exclamation-triangle"></i> Chưa điểm danh</h3></div>
            <div class="dashboard-card-body">
              ${data.pendingAttendance?.length ? `<table class="mini-table">
                ${data.pendingAttendance.map(s => `<tr>
                  <td><strong>${s.class_name}</strong> - Buổi ${s.session_number}</td>
                  <td>${ui.formatDate(s.session_date)}</td>
                  <td><a href="pages/attendance.html?sessionId=${s.id}" class="btn btn-sm btn-warning">Điểm danh</a></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Tất cả đã điểm danh ✓</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-chalkboard"></i> Lớp của tôi</h3><a href="pages/classes.html" class="btn btn-sm btn-secondary">Xem tất cả</a></div>
            <div class="dashboard-card-body">
              ${data.classes?.length ? `<table class="mini-table">
                ${data.classes.map(c => `<tr>
                  <td><strong>${c.class_name}</strong><br><small class="text-muted">${c.subject_name || ''} - ${c.level_name || ''}</small></td>
                  <td>${c.study_days || ''}<br><small>${c.start_time?.substring(0, 5) || ''}</small></td>
                  <td><span class="badge badge-info">${c.student_count} HS</span></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Chưa có lớp nào</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderCMDashboard(container, data) {
      const stats = data.stats || {};
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${stats.total_classes || 0}</div><div class="stat-label">Lớp quản lý</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${stats.total_students || 0}</div><div class="stat-label">Học sinh</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${data.todaySessions?.length || 0}</div><div class="stat-label">Buổi học hôm nay</div></div></div>
          <div class="stat-card"><div class="stat-icon danger"><i class="fas fa-exclamation-circle"></i></div><div class="stat-content"><div class="stat-value">${data.pendingAttendance?.length || 0}</div><div class="stat-label">Chưa điểm danh</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-day"></i> Buổi học hôm nay</h3></div>
            <div class="dashboard-card-body">
              ${data.todaySessions?.length ? data.todaySessions.map(s => `
                <div class="session-item">
                  <div class="session-time">${s.start_time?.substring(0, 5)}</div>
                  <div class="session-info">
                    <div class="class-name">${s.class_name} - Buổi ${s.session_number}</div>
                    <div class="meta">GV: ${s.teacher_name || 'N/A'}</div>
                  </div>
                  <span class="badge ${s.attendance_submitted ? 'badge-success' : 'badge-warning'}">${s.attendance_submitted ? 'Đã ĐD' : 'Chưa ĐD'}</span>
                </div>
              `).join('') : '<p class="empty">Không có buổi học hôm nay</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-exclamation-triangle"></i> Chưa điểm danh</h3></div>
            <div class="dashboard-card-body">
              ${data.pendingAttendance?.length ? `<table class="mini-table">
                ${data.pendingAttendance.map(s => `<tr>
                  <td><strong>${s.class_name}</strong> - Buổi ${s.session_number}</td>
                  <td>${ui.formatDate(s.session_date)}</td>
                  <td><small class="text-muted">${s.teacher_name || 'N/A'}</small></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Tất cả đã điểm danh ✓</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-chalkboard"></i> Lớp quản lý</h3><a href="pages/classes.html" class="btn btn-sm btn-secondary">Xem tất cả</a></div>
            <div class="dashboard-card-body">
              ${data.classes?.length ? `<table class="mini-table">
                ${data.classes.map(c => `<tr>
                  <td><strong>${c.class_name}</strong><br><small class="text-muted">${c.subject_name || ''}</small></td>
                  <td>${c.teacher_name || 'Chưa có GV'}</td>
                  <td><span class="badge badge-info">${c.student_count} HS</span></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Chưa có lớp nào</p>'}
            </div>
          </div>
        </div>
      `;
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!auth.checkAuth()) return;
      document.getElementById('welcomeName').textContent = auth.user?.full_name || 'User';
      buildSidebar('sidebar');
      loadDashboard();
    });
  </script>
</body>

</html>